---
layout: post
title:  "让骨架屏更快渲染"
cover: "/assets/img/post-bg-js-module.jpg"
date:   2018-03-13
category: coding
tags: vue webpack
author: xiaOp
comments: true
---

在之前[「为vue项目添加骨架屏」]({{ site.baseurl }}{% link _posts/2017-07-30-为vue项目添加骨架屏.md %})一文中，介绍了骨架屏的概念以及在 Vue 项目中的应用。本文将介绍如何加快浏览器对骨架屏的渲染。

## 骨架屏的渲染时机

让我们先来看一下时间线，打开 Chrome Devtool 中性能面板：
![](https://boscdn.baidu.com/assets/lavas/codelab/skeleton.png)

不难发现，在 HTML 下载完毕之后，浏览器仍然需要等待样式（index.css）下载完毕才开始渲染骨架屏。
这是由于浏览器构建渲染树需要 DOM 和 CSSOM，因此 HTML 和 CSS 都是会阻塞渲染的资源。这在大部分场景下都是合情合理的，毕竟让用户看到内容在样式加载前后闪烁（FOUC）是需要避免的。

但是骨架屏所需的样式已经内联在 HTML 中，供前端渲染内容使用的 CSS 显然不应该阻塞骨架屏的渲染。有没有办法改变这个特性呢？

## 将 link 挪到 body 中

首先想到的办法是，将 `<link>` 从 `<head>` 中挪到 `<body>` 中，HTML 规范允许这样做：
> A `<link>` tag can occur either in the head element or in the body element (or both), depending on whether it has a link type that is body-ok. For example, the stylesheet link type is body-ok, and therefore a `<link rel="stylesheet">` is permitted in the body.

这样 CSS 只会阻塞后续内容，骨架屏可以不受影响地被渲染。
{% prism html linenos %}
<head>
    <style>Skeleton CSS</style>
</head>
<body>
    <div>Skeleton DOM</div>
    <link rel='stylesheet' href='index.css'>
    <div id='app'>...</div>
</body>
{% endprism %}

但是在 Chrome 中测试后会发现 CSS 依然阻塞渲染，在 Chrome 的关于这个问题的一个[讨论](https://bugs.chromium.org/p/chromium/issues/detail?id=481122)中，能看到由于针对这种情况的渲染策略并没有严格的规范，不同浏览器下出现了不同的表现：
* Chrome 依旧阻塞渲染。[Webpagetest](http://www.webpagetest.org/video/compare.php?tests=150424_57_12PJ-r:1-c:0)
* IE 符合预期，仅仅阻塞后续内容。[Webpagetest](http://www.webpagetest.org/video/compare.php?tests=150424_NH_12XE-r:1-c:0)
* Firefox 完全不阻塞渲染，除非 head 中已经出现了 link。这样后续内容就会出现 FOUC。[Webpagetest](http://www.webpagetest.org/video/compare.php?tests=150424_MS_1297-r:1-c:0)。但是修复方式十分简单，在加上 script

[提案](https://bugs.chromium.org/p/chromium/issues/detail?id=481122#c45)
* 任何出现在 `<link>` 之后的 DOM 内容在样式表加载完成之前都不会被添加到渲染树中，也就是阻塞后续渲染。
* 为 `<link>` 增加 `async` 属性，类似 `<script>` 的 `defer/async`，不阻塞渲染，加载完毕立即应用。
* JS 插入的 `<link>` 视作异步。

## 异步加载样式表

## 参考资料

* [render-blocking-css](https://developers.google.com/web/fundamentals/performance/critical-rendering-path/render-blocking-css)
* [critical-rendering-path-css-fast-loading-website](https://www.sitepoint.com/critical-rendering-path-css-fast-loading-website/)
* [Chrome ISSUE](https://bugs.chromium.org/p/chromium/issues/detail?id=481122)
* [link-in-body](https://jakearchibald.com/2016/link-in-body/)