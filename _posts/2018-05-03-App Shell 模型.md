---
layout: post
title: "App Shell 模型"
subtitle: "在 PWA 中使用 App Shell 模型提升性能和用户感知体验"
cover: "/assets/img/vue-render.png"
date:   2018-05-03
category: coding
tags: vue
author: xiaOp
comments: true
index: 43
---

在构建 PWA 应用时，使用 App Shell 模型能够在视觉和首屏加载速度方面带来用户体验的提升。另外，在配合 Service Worker 离线缓存之后，用户在后续访问中将得到快速可靠的浏览体验。在实践过程中，借助流行框架与构建工具提供的众多特性，我们能够在项目中便捷地实现 App Shell 模型及其缓存方案。最后，在常见的 SPA 项目中，我们试图使用 Skeleton 方案进一步提升用户的感知体验。

## App Shell 模型

相比 Native App，PWA 有以下优势：
* Linkable 毕竟是 Web 站点，通过链接跳转，也便于分享以及索引。
* Progressive 渐进式提升站点体验。即使不支持 Service Worker 仍能运行。添加到主屏，消息推送等特性也是如此。
* Responsive 同样针对手持设备，开发者熟悉的响应式设计仍然能很好的应用。

我们都很熟悉 Native App 中常见的 Shell 展示效果，通常快速加载应用的简单 UI （顶部导航条，侧边栏，Loading 动画等）并缓存，后续访问甚至是离线状态仍能立即展示，而页面实际内容动态加载。PWA 在保持以上优势的基础上，也可以借鉴这一方案以提升性能和用户感知体验，这就是 App Shell 模型。

{% responsive_image path: assets/img/appshell.jpeg alt: "App Shell 模型" %}

我们对于 PWA 中的 App Shell 模型的大致总结：
* 内容上是由 HTML CSS 和 JS 组成的资源集合
* 它应该是快速加载运行展示并可以被缓存的
* 还需要负责后续动态加载页面实际内容
* 与 iOS/Android App 相比，体积小得多

那么在具体项目中应该如何应用这一模型呢？或者说，对于已有项目的改造成本有多大呢？

我们熟悉的 Web 项目的架构大致如下：
* Server-side Rendering 首屏加载速度快，但是后续每次页面间跳转都需要重新下载全部资源。
* Client-side Rendering 首屏加载速度慢，后续页面跳转迅速。

所以两者结合可以得到最好的效果，首屏由 SSR 渲染，后续由 CSR 动态渲染页面中部分内容，类似 SPA 的效果。
借助构建工具例如 Webpack 和前端框架（React Vue）提供的服务端渲染特性，同一套代码在编译后可以同时运行在双端，这就是 Universal/Isomorphic 同构应用。

首先我们来看 SPA 中

## SPA 中的应用

### PRPL 模式

* Push 推送 - 为初始网址路由推送关键资源。
* Render 渲染 - 渲染初始路由。
* Precache 预缓存 - 预缓存剩余路由。
* Lazyload 延迟加载 - 延迟加载并按需创建剩余路由。

Polymer 中
{% prism javascript linenos %}
let resolvedUrl = this.resolveUrl('list-view.html');

Polymer.importHref(
    resolvedUrl,
    null,  /* callback for successful load -- usually not needed */
    this._importFailedCallback.bind(this), /* for example, display 404 page */
    true); /* make import async */
{% endprism %}

在 PWA 中，使用 App Shell 模型将通用的资源与动态内容分离，可以实现对于用户的快速响应。配合 Service Worker 实现 App Shell 的预缓存之后，在弱网甚至离线环境依然能给予用户可靠的浏览体验。另外，借助流行框架与构建工具的先进特性，开发者不必从头实现 App Shell 的全部细节。

(1) 介绍 PRPL 模式和 App Shell 模型思想
(2) 介绍应用该模型后，在用户体验上带来的提升效果
    1. 用户浏览站点时，带来近似 Native App 的视觉效果
    2. 提升首屏加载速度
(3) 介绍在实际项目开发中，如何借助框架和构建工具实现该模型
(4) 介绍在不同架构（SPA、MPA、SSR）下的 Service Worker 通用预缓存方案

## SSR 中的应用


## Skeleton 方案

为了进一步提升用户感知体验，在 SPA 中可以使用 Skeleton (骨架屏)减少白屏时间。
我们将介绍两种生成方案的实现思路，以及在灵活可用性、展现速度上的优化方式。

(1) 构建阶段的生成方案，包含以下两种：
    1. 额外编写组件。使用框架的 SSR (服务端渲染)功能
    2. 自动化生成。使用 headless Chrome 渲染真实页面内容，随后使用占位符进行替换
(2) 解决 SPA 中多页面差异性问题。根据不同页面路由展现不同内容
(3) 优化展现速度。异步加载样式，避免阻塞以进一步减少白屏时间

## 参考资料

[](https://developer.mozilla.org/en-US/Apps/Progressive/App_structure)
[appshell](https://www.youtube.com/watch?v=QhUzmR8eZAo)
[appshell](https://medium.com/google-developers/instant-loading-web-apps-with-an-application-shell-architecture-7c0c2f10c73)

[Skeleton](https://medium.com/@owencm/reactive-web-design-the-secret-to-building-web-apps-that-feel-amazing-b5cbfe9b7c50)
https://developers.google.com/web/showcase/2016/iowa2016?hl=zh-cn
https://developers.google.com/web/fundamentals/architecture/app-shell?hl=zh-cn
https://developers.google.com/web/fundamentals/performance/prpl-pattern/
https://huangxuan.me/2017/07/12/upgrading-eleme-to-pwa/
https://zhuanlan.zhihu.com/p/34702561